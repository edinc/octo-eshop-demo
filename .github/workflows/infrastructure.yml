name: Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to provision'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan

permissions:
  id-token: write
  contents: read

jobs:
  # On push: plan all environments to validate changes
  plan-dev:
    name: Plan Dev
    if: github.event_name == 'push'
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: dev
      action: plan
    secrets: inherit

  plan-staging:
    name: Plan Staging
    if: github.event_name == 'push'
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: staging
      action: plan
    secrets: inherit

  plan-production:
    name: Plan Production
    if: github.event_name == 'push'
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: production
      action: plan
    secrets: inherit

  # On dispatch: run against selected environment
  dispatch:
    name: Dispatch
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      action: ${{ inputs.action }}
    secrets: inherit
