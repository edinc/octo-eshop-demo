name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true

permissions:
  id-token: write
  contents: read

env:
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "::error::You must type 'DEPLOY' to confirm production deployment"
            exit 1
          fi
          echo "Confirmation validated"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP_PROD }} \
            --name ${{ secrets.AKS_CLUSTER_NAME_PROD }} \
            --overwrite-existing

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Pre-deployment checks
        run: |
          echo "=== Current deployment status ==="
          kubectl get deployments -n octo-eshop-production 2>/dev/null || echo "No existing deployments"

          echo "=== Current pod status ==="
          kubectl get pods -n octo-eshop-production 2>/dev/null || echo "No existing pods"

      - name: Create namespace if not exists
        run: |
          kubectl create namespace octo-eshop-production --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy services with Helm
        run: |
          TAG=${{ github.event.inputs.image_tag }}
          NS="octo-eshop-production"

          # Deploy network policies first
          helm upgrade --install network-policies ./helm/charts/network-policies \
            --namespace "${NS}" --wait --timeout 2m

          # Deploy each service with production values
          for service in user-service product-service cart-service order-service payment-service frontend; do
            echo "Deploying ${service} to production..."
            helm upgrade --install "${service}" "./helm/charts/${service}" \
              --namespace "${NS}" \
              -f "./helm/charts/${service}/values.yaml" \
              -f "./helm/charts/${service}/values-production.yaml" \
              --set "image.tag=${TAG}" \
              --set "image.repository=${ACR_REGISTRY}/${service}" \
              --wait --timeout 10m
          done

      - name: Verify deployment
        run: |
          NS="octo-eshop-production"
          kubectl get pods -n "${NS}"
          kubectl get services -n "${NS}"
          helm list -n "${NS}"

      - name: Create deployment record
        run: |
          echo "Deployed at: $(date -u)" >> deployment-record.txt
          echo "Image tag: ${{ github.event.inputs.image_tag }}" >> deployment-record.txt
          echo "Deployed by: ${{ github.actor }}" >> deployment-record.txt

      - name: Upload deployment record
        uses: actions/upload-artifact@v4
        with:
          name: deployment-record
          path: deployment-record.txt
